<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNT Grade Distributions</title>
    <!-- CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
    <style>
      body {
        font-family: 'Lato', Arial, sans-serif;
      }
      label {
        font-family: 'Lato', Arial, sans-serif;
      }
      .banner {
        font-family: 'Lato', Arial sans-serif;
      }
      .topbanner {
        margin-bottom: 15px;
      }
      .bodybanner {
        padding: 10px;
      }
      .untgreen {
        background-color: #00853E;
        color: #f5f5f5;
      }
    </style>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({
              google_ad_client: "ca-pub-6546362164503137",
              enable_page_level_ads: true
         });
    </script>
  </head>
  <body>
    <div class="banner topbanner untgreen">
      <div class="container-fluid">
        <div class="row">
          <div class="col-xs-12">
            <h1 style="text-align: center;"><span style="font-size: 32px"><b>UNT Grade Distributions</b></span></h1>
          </div>
        </div>
      </div>
    </div>
    <div class="container-fluid">
      <div class="row">
        <div class="col-xs-12">
            <div class="row">
              <div class="col-md-2">
                <!-- nothing -->
              </div>
              <div class="col-md-4">
                <h2>Free, as they should be</h2>
                <p>Unlimited access to grade distributions in all classes in fall 2017 and spring 2018. Transparency for your academic success.</p>
                <p>Grade distributions are historical data on how many letter grades of each kind were handed out in classes. Picking classes with favorable grade distributions helps you increase your chance of academic success and timely graduation.</p>
              </div>
              <div class="col-md-4">
                <h2>Instructions</h2>
                <p>Select the semester you are interested in, and type in either the subject and course number or the instructor or both. You can specify partial queries (for instance, "Smith" or even "Smi" instead of "John Smith").</p>
                <p>Relevant sections will show up below the search form. Select the section you want to view and see its graph appear to the right.</p>
              </div>
              <div class="col-md-2">
                <!-- nothing -->
              </div>
            </div>
            <hr />
            <div class="row">
              <div class="col-md-2"></div>
              <div class="col-md-3">
                <!-- Query -->
                <h2>Search</h2>
                <div class="form-group">
                  <label for="semester">Semester</label>
                  <select name="semester" id="semester">
                    <option value="2017 Fall">2017 Fall - 1178</option>
                    <option value="2018 Spring">2018 Spring - 1181</option>
                  </select>
                </div>
                <form onsubmit="findClasses()" action="javascript:void(0)">
                    <div class="well well-sm">
                    <div class="row">
                        <div class="col-md-6">
                        <div class="form-group">
                            <label for="subject">Subject</label>
                            <input type="text" class="form-control" name="subject" id="subject" placeholder="MATH" />
                        </div>
                        </div>
                        <div class="col-md-6">
                        <div class="form-group">
                            <label for="course">Course number</label>
                            <input type="text" class="form-control" name="course" id="course" placeholder="1710" />
                        </div>
                        </div>
                    </div>
                    </div>
                    <div class="well well-sm">
                    <div class="form-group">
                        <label for="instructor">Instructor</label>
                        <input type="text" class="form-control" name="instructor" id="instructor" placeholder="Smith" />
                    </div>
                    </div>
                    <button class="btn btn-primary" type="submit"><span class="glyphicon glyphicon-search" aria-hidden="true"></span> Search</button>
                </form>
                <h2>Select</h2>
                <ul id="select_result">Your search results will be displayed here.</ul>
              </div>
              <div class="col-md-5">
                <!-- Results -->
                <h2>Results</h2>
                <div id="chart" style="width:100%; height:400px;">Your graph will be displyed here.</div>
              </div>
              <div class="col-md-2"></div>
            </div>
            <div class="row">
              <div class="col-md-2">
                <!-- nothing -->
              </div>
              <div class="col-md-4">
                <h2>Downloading data</h2>
                <p>The grade distribution data we have is freely available for your perusal.</p>
                <ul>
                  <li><a href="https://jeffw16.github.io/unt-grade-distributions/static/UNT_Grade_Distribution_Request_2017-2018.csv">CSV</a></li>
                  <li><a href="https://jeffw16.github.io/unt-grade-distributions/static/UNT_Grade_Distribution_Request_2017-2018.xlsx">XLSX (Excel)</a></li>
                </ul>
                <h2>Developer's notes</h2>
                <p>This set of data is incomplete. We are working with the Registrar's Office to resolve this issue and will update our dataset as soon as possible.</p>
                <p>New features are still being added to our website. If you want to join the development team, email the lead developer at his email address <a href="mailto:jeffreywang@my.unt.edu">jeffreywang@my.unt.edu</a>.</p>
              </div>
              <div class="col-md-4">
                <h2>Donating to the cause</h2>
                <p>Grade distributions cost $69.16 per semester to retrieve from the UNT Registrar's Office. Your donations directly fund future grade distribution requests and help students like you choose the best classes.</p>
                <p>Send $1 or more to our project leader's Venmo: @jeffw16. All donations will be used to fund future semesters' requests and will never be kept for personal gain.</p>
              </div>
              <div class="col-md-2">
                <!-- nothing -->
              </div>
            </div>
            <div class="row">
              <div class="col-md-2"></div>
              <div class="col-md-8">
                <p style="text-align: center;">&copy; 2018 UNT Grade Distributions Team. Some functionality borrowed from the UT Catalyst Grade Distributions tool. Not affiliated with or sponsored by the University of North Texas.</p>
                <p style="text-align: center;">Old tool located at <a href="https://jeffw.xyz/public/untgradedistributions_temp">this link</a>.</p>
              </div>
              <div class="col-md-2"></div>
            </div>
        </div>
      </div>
    </div>
    <!-- JavaScript -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="https://kripken.github.io/sql.js/js/sql.js"></script>
    <!-- <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script> -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function(){
        var xhr = new XMLHttpRequest();
        xhr.open('GET', 'https://cdn.rawgit.com/jeffw16/unt-grade-distributions/09176222/static/UNT.db', true);
        xhr.responseType = 'arraybuffer';
        xhr.onload = function(e) {
            var uInt8Array = new Uint8Array(this.response);
            window.db = new SQL.Database(uInt8Array);
            if(window.waiting){
                findClasses();
            }
        };
        xhr.send();
    })
    function findClasses() {
        var select_result = document.getElementById('select_result');
        select_result.innerHTML = "loading...";
        if(!window.db){
            window.loading = true;
            return;
        }
        var contents = window.db.exec(generateQuery());
        if ( contents.length == 0 ) {
            select_result.innerHTML = "No results were found. Try modifying your query. While we strive to keep a complete record, there may be some deficiencies in what the registrar provides us.";
        } else {
            select_result.innerHTML = "";
            for ( var i = 0; i < contents[0]['values'].length; i++ ) {
                var item = document.createElement('li');
                let entry = contents[0]['values'][i]; // use "let" instead of "var" so variable scope is local
                item.appendChild(document.createTextNode(formatResult(entry)));
                item.style.color = "#2f843e";
                item.style.cursor = 'pointer';
                item.onclick = function(){ compileChart(entry); };
                document.getElementById('select_result').append(item);
            }
        }
    }

    function generateQuery() {
      var query = "SELECT * FROM UNT";

      var semester = document.getElementById('semester').value;
      var subject = document.getElementById('subject').value;
      var course = document.getElementById('course').value;
      var instructor = document.getElementById('instructor').value;

      query += " WHERE Term LIKE '%" + semester + "%'";
      query += " AND Subject LIKE '%" + subject + "%'";
      query += " AND Catalog LIKE '%" + course + "%'"; // not sure why it's called Catalog, but okay
      query += " AND Instructor LIKE '%" + instructor + "%' COLLATE NOCASE;";
      return query;
    }

    function formatResult( result ) {
        return result[1] + " " + result[2] + "." + result[3] + " " + result[4] + " (" + result[5] + ") - " + result[0];
    }

    function compileChart( result ) {
        var [semester, subject, course_code, section, course_name, instructor, true_total_enrollment] = result;
        var nums = result.slice(7, 12).map(parseFloat);
        var colors = ['#30c737', '#93d10d', '#ffe14d', '#ffad33', '#ff704d'];
        var total = nums.reduce((a, b) => a+b, 0);
        var myChart = Highcharts.chart('chart', {
            chart: {
              type: 'column'
            },
            title: {
              text: subject + ' ' + course_code + '.' + section + ' (' + instructor + ')'
            },
            subtitle:{
              text: course_name + ' - ' + semester
            },
            legend: {
              enabled: false
            },
            xAxis: {
              title: {
                text: 'Grades'
              },
              categories: ['A', 'B', 'C', 'D', 'F']
            },
            yAxis: {
              title: {
                text: 'Students'
              }
            },
            tooltip: {
                headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                pointFormat: `
                    <tr>
                        <td style="color:{series.color};padding:0">{series.name}: </td>
                        <td style="padding:0"><b>{point.y}</b></td>
                    </tr>
                    <tr>
                        <td style="color:{series.color};padding:0">Percentage: </td>
                        <td style="padding:0"><b>{point.percentage:.2f}%</b></td>
                    </tr>
                    `,
                footerFormat: '</table>',
                shared: true,
                useHTML: true
            },
            series: [{
              name: 'Students',
              data: nums.map((num, i) => {
                  return {y: num, color: colors[i], percentage: num/total*100};
              })
            }]
        });
    }
    </script>
  </body>
</html>
